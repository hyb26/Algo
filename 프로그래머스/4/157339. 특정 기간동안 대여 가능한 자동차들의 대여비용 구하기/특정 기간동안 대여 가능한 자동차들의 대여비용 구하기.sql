SELECT DISTINCT 
    r.CAR_ID, 
    r.CAR_TYPE, 
    ROUND(r.DAILY_FEE * 30 * (100 - CAST(SUBSTRING_INDEX(p.DISCOUNT_RATE, '%', 1) AS UNSIGNED)) / 100, 0) AS FEE
FROM CAR_RENTAL_COMPANY_CAR r
LEFT JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN p ON r.CAR_TYPE = p.CAR_TYPE AND p.DURATION_TYPE = '30일 이상'
WHERE (r.CAR_TYPE = 'SUV' OR r.CAR_TYPE = '세단')
  AND r.DAILY_FEE * 30 * (100 - CAST(SUBSTRING_INDEX(p.DISCOUNT_RATE, '%', 1) AS UNSIGNED)) / 100 BETWEEN 500000 AND 1999999
  AND r.CAR_ID NOT IN (
    SELECT DISTINCT CAR_ID
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
    WHERE (START_DATE BETWEEN '2022-11-01' AND '2022-11-30')
       OR (END_DATE BETWEEN '2022-11-01' AND '2022-11-30')
       OR (START_DATE < '2022-11-01' AND END_DATE > '2022-11-30')
  )
ORDER BY FEE DESC, r.CAR_TYPE ASC, r.CAR_ID DESC;